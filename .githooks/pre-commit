#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Phase A: read-only checks…"

# Collect staged files
PRETTIER_ABS=()    # repo-relative (frontend)
PRETTIER_REL=()    # app-relative for running inside apps/frontend
ESLINT_REL=()      # staged frontend code files (app-relative)
RUST_STAGED=()     # repo-relative staged Rust files (backend)

while IFS= read -r -d '' path; do
  case "$path" in
    # Frontend staged files
    apps/frontend/*)
      rel="${path#apps/frontend/}"
      case "$path" in
        # ESLint targets
        *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs)
          ESLINT_REL+=("$rel")
          ;;
      esac
      case "$path" in
        # Prettier targets
        *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs|*.json|*.md|*.mdx|*.css|*.scss|*.yml|*.yaml|*.html)
          PRETTIER_ABS+=("$path")
          PRETTIER_REL+=("$rel")
          ;;
      esac
      ;;
    # Backend staged files
    apps/backend/*)
      case "$path" in
        *.rs)
          RUST_STAGED+=("$path")
          ;;
      esac
      ;;
  esac
done < <(git diff --cached -z --name-only --diff-filter=ACMR)

# Backend clippy (read-only) via package script
echo "  • backend:clippy"
pnpm backend:clippy

# Frontend ESLint (staged-only, read-only) via package script + arg passthrough
if ((${#ESLINT_REL[@]})); then
  echo "  • eslint (staged frontend code only)"
  pnpm frontend:lint -- "${ESLINT_REL[@]}"
else
  echo "  • eslint: no staged frontend code files"
fi

echo "[pre-commit] Phase A OK ✅"
echo "[pre-commit] Phase B: formatting staged files…"

# Rustfmt (staged backend files only) — keep staged-only for speed
if ((${#RUST_STAGED[@]})); then
  echo "  • rustfmt (staged backend .rs files)"
  rustfmt --edition 2021 -- "${RUST_STAGED[@]}" || true
  git add -- "${RUST_STAGED[@]}" || true
else
  echo "  • rustfmt: no staged backend .rs files"
fi

# Prettier (staged frontend files only) via package script + arg passthrough
if ((${#PRETTIER_REL[@]})); then
  echo "  • prettier --write (staged frontend files)"
  pnpm frontend:fmt -- "${PRETTIER_REL[@]}"
  git add -- "${PRETTIER_ABS[@]}" || true
else
  echo "  • prettier: no staged frontend files"
fi

echo "[pre-commit] OK ✅"

