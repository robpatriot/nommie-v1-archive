#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Checking Rust formatting..."
cargo fmt --manifest-path ./apps/backend/Cargo.toml -- --check

echo "[pre-commit] Running clippy (deny warnings)..."
cargo clippy --manifest-path ./apps/backend/Cargo.toml --all-targets --all-features -- -D warnings

# Arrays for files
PRETTIER_ABS=()  # repo-relative
ESLINT_ABS=()
PRETTIER_REL=()  # app-relative (for -C apps/frontend)
ESLINT_REL=()

# Collect staged files (added/copied/modified/renamed), NUL-delimited
git diff --cached -z --name-only --diff-filter=ACMR | \
while IFS= read -r -d '' path; do
  # Only consider frontend files
  case "$path" in
    apps/frontend/*)
      rel="${path#apps/frontend/}"
      # Prettier set (broad, includes JSON)
      case "$path" in
        *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs|*.json|*.md|*.mdx|*.css|*.scss|*.yml|*.yaml|*.html)
          PRETTIER_ABS+=("$path")
          PRETTIER_REL+=("$rel")
          ;;
      esac
      # ESLint set (code only)
      case "$path" in
        *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs)
          ESLINT_ABS+=("$path")
          ESLINT_REL+=("$rel")
          ;;
      esac
      ;;
    *) ;;
  esac
done

# Run Prettier
if ((${#PRETTIER_REL[@]})); then
  echo "[pre-commit] Formatting staged frontend files with Prettier..."
  pnpm -C apps/frontend exec prettier --write -- "${PRETTIER_REL[@]}"
  # Re-stage formatted files using repo-relative paths
  git add -- "${PRETTIER_ABS[@]}"
else
  echo "[pre-commit] No frontend files to format."
fi

# Run ESLint
if ((${#ESLINT_REL[@]})); then
  echo "[pre-commit] Linting staged frontend code with ESLint..."
  pnpm -C apps/frontend exec eslint --max-warnings=0 --cache -- "${ESLINT_REL[@]}"
else
  echo "[pre-commit] No frontend code files to lint."
fi

echo "[pre-commit] OK"

